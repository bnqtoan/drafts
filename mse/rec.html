<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trực Quan Hóa Hệ Thống Gợi Ý</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sử dụng font Inter cho toàn bộ trang */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom style cho canvas để có nền và bo góc đẹp hơn */
        canvas {
            background-color: #1f2937; /* gray-800 */
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #4b5563; /* gray-600 */
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">Trực Quan Hóa Hệ Thống Gợi Ý</h1>
            <p class="text-lg text-gray-400">Khám phá cách các mô hình Machine Learning "suy nghĩ"</p>
        </header>

        <main class="space-y-12">
            <!-- Phần 1: Content-Based Recommender -->
            <section class="bg-gray-800/50 p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- Bảng điều khiển và giải thích -->
                    <div class="md:w-1/3 space-y-4">
                        <h2 class="text-3xl font-bold text-cyan-400">1. Lọc Dựa Trên Nội Dung</h2>
                        <p class="text-gray-300">
                            Mô hình này hoạt động như một "nhà phê bình", gợi ý phim dựa trên sự tương đồng về nội dung (ví dụ: thể loại). 
                            Nó biến mỗi bộ phim thành một **vector** và đo **góc** giữa chúng để tìm ra phim giống nhau nhất.
                        </p>
                        <div>
                            <label for="movieSelect" class="block mb-2 font-semibold text-gray-300">Chọn một phim bạn thích:</label>
                            <select id="movieSelect" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:ring-cyan-500 focus:border-cyan-500">
                                <!-- Các option sẽ được thêm bằng JavaScript -->
                            </select>
                        </div>
                        <div id="content-explanation" class="bg-gray-900 p-4 rounded-lg text-sm h-64 overflow-y-auto border border-gray-700">
                            <p class="text-gray-500">Hãy chọn một phim để xem phân tích độ tương đồng...</p>
                        </div>
                    </div>
                    <!-- Canvas vẽ -->
                    <div class="md:w-2/3">
                        <canvas id="contentCanvas" width="800" height="600"></canvas>
                    </div>
                </div>
            </section>

            <!-- Phần 2: Collaborative Filtering Recommender -->
            <section class="bg-gray-800/50 p-6 rounded-xl shadow-lg border border-gray-700">
                <div class="flex flex-col md:flex-row gap-6">
                     <!-- Canvas vẽ -->
                     <div class="md:w-2/3 order-2 md:order-1">
                        <canvas id="collaborativeCanvas" width="800" height="400"></canvas>
                    </div>
                    <!-- Bảng điều khiển và giải thích -->
                    <div class="md:w-1/3 space-y-4 order-1 md:order-2">
                        <h2 class="text-3xl font-bold text-violet-400">2. Lọc Cộng Tác</h2>
                        <p class="text-gray-300">
                           Mô hình này hoạt động như một "người mai mối", không quan tâm nội dung phim. Nó tìm những người dùng có **"gu" giống bạn** và gợi ý những phim mà họ thích nhưng bạn chưa xem.
                        </p>
                        <div>
                            <label for="userSelect" class="block mb-2 font-semibold text-gray-300">Chọn một người dùng để xem gợi ý:</label>
                            <select id="userSelect" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:ring-violet-500 focus:border-violet-500">
                                <!-- Các option sẽ được thêm bằng JavaScript -->
                            </select>
                        </div>
                        <div id="collab-explanation" class="bg-gray-900 p-4 rounded-lg text-sm h-48 overflow-y-auto border border-gray-700">
                             <p class="text-gray-500">Hãy chọn một người dùng để xem gợi ý...</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Tạo ra để minh họa cho đồ án Movie Recommender System.</p>
        </footer>
    </div>

<script>
// Chờ cho toàn bộ nội dung trang được tải
document.addEventListener('DOMContentLoaded', () => {

    // --- PHẦN 1: CONTENT-BASED VISUALIZATION ---
    const canvasContent = document.getElementById('contentCanvas');
    const ctxContent = canvasContent.getContext('2d');
    const movieSelect = document.getElementById('movieSelect');
    const contentExplanation = document.getElementById('content-explanation');

    // Dữ liệu phim mẫu với vector 2D [Action, Comedy]
    const movies = [
        { name: 'Iron Man', vector: [0.9, 0.4], color: '#f87171' }, // red-400
        { name: 'The Avengers', vector: [0.95, 0.5], color: '#f87171' },
        { name: 'The Hangover', vector: [0.1, 0.9], color: '#4ade80' }, // green-400
        { name: 'Superbad', vector: [0.15, 0.95], color: '#4ade80' },
        { name: 'Rush Hour', vector: [0.7, 0.8], color: '#60a5fa' }, // blue-400
        { name: 'The Dark Knight', vector: [0.8, 0.1], color: '#a78bfa' }, // violet-400
        { name: 'Inception', vector: [0.7, 0.2], color: '#a78bfa' },
    ];
    
    let selectedMovie = movies[0];

    // Populate dropdown
    movies.forEach(movie => {
        const option = document.createElement('option');
        option.value = movie.name;
        option.textContent = movie.name;
        movieSelect.appendChild(option);
    });

    // Hàm tính Cosine Similarity
    function cosineSimilarity(vecA, vecB) {
        const dotProduct = vecA[0] * vecB[0] + vecA[1] * vecB[1];
        const magnitudeA = Math.sqrt(vecA[0] * vecA[0] + vecA[1] * vecA[1]);
        const magnitudeB = Math.sqrt(vecB[0] * vecB[0] + vecB[1] * vecB[1]);
        if (magnitudeA === 0 || magnitudeB === 0) return 0;
        return dotProduct / (magnitudeA * magnitudeB);
    }
    
    // Hàm vẽ cho Content-Based
    function drawContentBased() {
        const { width, height } = canvasContent;
        ctxContent.clearRect(0, 0, width, height);

        const padding = 60;
        const origin = { x: padding, y: height - padding };

        // Vẽ trục tọa độ
        ctxContent.beginPath();
        ctxContent.strokeStyle = '#4b5563'; // gray-600
        ctxContent.lineWidth = 1;
        ctxContent.moveTo(padding, 0);
        ctxContent.lineTo(padding, height - padding);
        ctxContent.lineTo(width, height - padding);
        ctxContent.stroke();
        ctxContent.fillStyle = '#9ca3af'; // gray-400
        ctxContent.font = '14px Inter';
        ctxContent.textAlign = 'center';
        ctxContent.fillText('Hành động', width / 2, height - 15);
        ctxContent.save();
        ctxContent.translate(15, height / 2);
        ctxContent.rotate(-Math.PI / 2);
        ctxContent.fillText('Hài hước', 0, 0);
        ctxContent.restore();

        // Tính toán tọa độ vẽ
        const plotWidth = width - padding * 1.5;
        const plotHeight = height - padding * 1.5;

        // Vẽ các vector
        movies.forEach(movie => {
            const x = origin.x + movie.vector[0] * plotWidth;
            const y = origin.y - movie.vector[1] * plotHeight;
            
            ctxContent.beginPath();
            ctxContent.moveTo(origin.x, origin.y);
            ctxContent.lineTo(x, y);
            ctxContent.strokeStyle = movie === selectedMovie ? '#facc15' : '#374151'; // yellow-400 or gray-700
            ctxContent.lineWidth = movie === selectedMovie ? 3 : 1;
            ctxContent.stroke();
        });

        // Vẽ các điểm phim
        movies.forEach(movie => {
            const x = origin.x + movie.vector[0] * plotWidth;
            const y = origin.y - movie.vector[1] * plotHeight;

            ctxContent.beginPath();
            ctxContent.arc(x, y, 7, 0, Math.PI * 2);
            ctxContent.fillStyle = movie.color;
            ctxContent.fill();
            if (movie === selectedMovie) {
                 ctxContent.strokeStyle = '#facc15';
                 ctxContent.lineWidth = 3;
                 ctxContent.stroke();
            }

            ctxContent.fillStyle = '#e5e7eb'; // gray-200
            ctxContent.font = '12px Inter';
            ctxContent.textAlign = 'left';
            ctxContent.fillText(movie.name, x + 10, y + 4);
        });

        updateContentExplanation();
    }
    
    // Cập nhật bảng giải thích
    function updateContentExplanation() {
        contentExplanation.innerHTML = `<h3 class="font-bold text-white mb-2">Phân tích cho: ${selectedMovie.name}</h3>`;
        const similarities = [];
        movies.forEach(movie => {
            if (movie !== selectedMovie) {
                const similarity = cosineSimilarity(selectedMovie.vector, movie.vector);
                similarities.push({ name: movie.name, score: similarity });
            }
        });

        // Sắp xếp theo độ tương đồng
        similarities.sort((a, b) => b.score - a.score);

        const list = document.createElement('ul');
        list.className = 'space-y-2';
        similarities.forEach(sim => {
            const scorePercent = (sim.score * 100).toFixed(1);
            const barWidth = scorePercent > 0 ? scorePercent : 0;
            const item = document.createElement('li');
            item.innerHTML = `
                <div class="flex justify-between items-center text-xs mb-1">
                    <span>${sim.name}</span>
                    <span class="font-mono text-cyan-300">${scorePercent}%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-1.5">
                    <div class="bg-cyan-400 h-1.5 rounded-full" style="width: ${barWidth}%"></div>
                </div>
            `;
            list.appendChild(item);
        });
        contentExplanation.appendChild(list);
    }

    // Event listener cho dropdown
    movieSelect.addEventListener('change', (e) => {
        selectedMovie = movies.find(m => m.name === e.target.value);
        drawContentBased();
    });

    // --- PHẦN 2: COLLABORATIVE FILTERING VISUALIZATION ---
    const canvasCollab = document.getElementById('collaborativeCanvas');
    const ctxCollab = canvasCollab.getContext('2d');
    const userSelect = document.getElementById('userSelect');
    const collabExplanation = document.getElementById('collab-explanation');

    const collabData = {
        users: [
            { id: 1, name: 'Bạn' },
            { id: 2, name: 'An' },
            { id: 3, name: 'Bình' }
        ],
        movies: [
            { id: 101, name: 'Inception' },
            { id: 102, name: 'La La Land' },
            { id: 103, name: 'Interstellar' }
        ],
        ratings: [
            { userId: 1, movieId: 101, rating: 5 }, // Bạn thích Inception
            { userId: 1, movieId: 102, rating: 1 }, // Bạn ghét La La Land
            { userId: 2, movieId: 101, rating: 5 }, // An thích Inception
            { userId: 2, movieId: 102, rating: 1 }, // An ghét La La Land
            { userId: 2, movieId: 103, rating: 5 }, // An thích Interstellar
            { userId: 3, movieId: 101, rating: 2 }, // Bình không thích Inception
            { userId: 3, movieId: 102, rating: 5 }, // Bình thích La La Land
        ]
    };

    let selectedUserId = 1;
    
    // Populate dropdown
    collabData.users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.name;
        userSelect.appendChild(option);
    });

    function drawCollaborative() {
        const { width, height } = canvasCollab;
        ctxCollab.clearRect(0, 0, width, height);

        const userColX = width * 0.2;
        const movieColX = width * 0.8;
        
        const userPositions = {};
        const moviePositions = {};

        // Vẽ user nodes
        collabData.users.forEach((user, i) => {
            const y = (height / (collabData.users.length + 1)) * (i + 1);
            userPositions[user.id] = { x: userColX, y };
            
            ctxCollab.fillStyle = user.id === selectedUserId ? '#facc15' : '#a78bfa'; // yellow-400 or violet-400
            ctxCollab.beginPath();
            ctxCollab.arc(userColX, y, 20, 0, Math.PI * 2);
            ctxCollab.fill();

            ctxCollab.fillStyle = '#111827';
            ctxCollab.font = 'bold 14px Inter';
            ctxCollab.textAlign = 'center';
            ctxCollab.textBaseline = 'middle';
            ctxCollab.fillText(user.name, userColX, y);
        });

        // Vẽ movie nodes
        collabData.movies.forEach((movie, i) => {
            const y = (height / (collabData.movies.length + 1)) * (i + 1);
            moviePositions[movie.id] = { x: movieColX, y };

            ctxCollab.fillStyle = '#2dd4bf'; // teal-400
            ctxCollab.fillRect(movieColX - 40, y - 20, 80, 40);

            ctxCollab.fillStyle = '#111827';
            ctxCollab.font = '12px Inter';
            ctxCollab.fillText(movie.name, movieColX, y);
        });

        // Vẽ các đường rating
        collabData.ratings.forEach(rating => {
            const userPos = userPositions[rating.userId];
            const moviePos = moviePositions[rating.movieId];
            
            ctxCollab.beginPath();
            ctxCollab.moveTo(userPos.x, userPos.y);
            ctxCollab.lineTo(moviePos.x, moviePos.y);
            
            ctxCollab.strokeStyle = rating.rating >= 4 ? '#4ade80' : '#f87171'; // green-400 or red-400
            ctxCollab.lineWidth = rating.rating;
            ctxCollab.globalAlpha = 0.6;
            ctxCollab.stroke();
            ctxCollab.globalAlpha = 1.0;
        });
        
        // Truyền các biến cục bộ (positions, height) vào hàm cập nhật
        updateCollabExplanation(userPositions, moviePositions, height);
    }
    
    function updateCollabExplanation(userPositions, moviePositions, height) {
         // Logic tìm người giống nhất và phim gợi ý
        const targetUserRatings = collabData.ratings.filter(r => r.userId === selectedUserId);
        let mostSimilarUser = null;
        let maxSimilarity = -1;

        collabData.users.forEach(user => {
            if (user.id === selectedUserId) return;
            
            const otherUserRatings = collabData.ratings.filter(r => r.userId === user.id);
            let similarity = 0;
            
            targetUserRatings.forEach(targetRating => {
                otherUserRatings.forEach(otherRating => {
                    if (targetRating.movieId === otherRating.movieId) {
                        // Cùng thích hoặc cùng ghét thì tăng điểm
                        if ((targetRating.rating >= 4 && otherRating.rating >=4) || (targetRating.rating <= 2 && otherRating.rating <= 2)) {
                            similarity++;
                        }
                    }
                });
            });
            
            if (similarity > maxSimilarity) {
                maxSimilarity = similarity;
                mostSimilarUser = user;
            }
        });
        
        let recommendedMovie = null;
        if (mostSimilarUser) {
            const similarUserRatings = collabData.ratings.filter(r => r.userId === mostSimilarUser.id && r.rating >= 4);
            const targetUserMovieIds = targetUserRatings.map(r => r.movieId);
            
            for (const rating of similarUserRatings) {
                if (!targetUserMovieIds.includes(rating.movieId)) {
                    recommendedMovie = collabData.movies.find(m => m.id === rating.movieId);
                    break;
                }
            }
        }
        
        // Hiển thị giải thích
        collabExplanation.innerHTML = '';
        const selectedUserName = collabData.users.find(u => u.id === selectedUserId).name;

        let html = `<h3 class="font-bold text-white mb-2">Phân tích cho: ${selectedUserName}</h3>`;
        if (mostSimilarUser) {
            html += `<p class="mb-2">1. Tìm thấy người dùng có "gu" giống nhất là <strong class="text-violet-300">${mostSimilarUser.name}</strong>.</p>`;
            // Highlight người dùng giống nhất
            ctxCollab.strokeStyle = '#60a5fa'; // blue-400
            ctxCollab.lineWidth = 4;
            ctxCollab.beginPath();
            const userPos = userPositions[mostSimilarUser.id];
            ctxCollab.arc(userPos.x, userPos.y, 25, 0, Math.PI * 2);
            ctxCollab.stroke();

            if (recommendedMovie) {
                html += `<p class="mb-2">2. Người dùng <strong class="text-violet-300">${mostSimilarUser.name}</strong> rất thích phim <strong class="text-teal-300">${recommendedMovie.name}</strong>, mà <strong class="text-yellow-300">${selectedUserName}</strong> chưa xem.</p>`;
                html += `<p class="font-bold text-green-400">➡️ Gợi ý: Phim <strong class="text-teal-300">${recommendedMovie.name}</strong> cho <strong class="text-yellow-300">${selectedUserName}</strong>.</p>`;
                
                // Vẽ đường gợi ý
                const targetPos = userPositions[selectedUserId];
                const moviePos = moviePositions[recommendedMovie.id];
                ctxCollab.beginPath();
                ctxCollab.moveTo(targetPos.x, targetPos.y);
                ctxCollab.lineTo(moviePos.x, moviePos.y);
                ctxCollab.setLineDash([10, 5]);
                ctxCollab.strokeStyle = '#fde047'; // yellow-300
                ctxCollab.lineWidth = 3;
                ctxCollab.stroke();
                ctxCollab.setLineDash([]);
            } else {
                 html += `<p>2. Không tìm thấy phim nào phù hợp để gợi ý từ ${mostSimilarUser.name}.</p>`;
            }
        } else {
            html += `<p>Không tìm thấy người dùng nào đủ giống để đưa ra gợi ý.</p>`;
        }
        collabExplanation.innerHTML = html;
    }

    userSelect.addEventListener('change', (e) => {
        selectedUserId = parseInt(e.target.value, 10);
        drawCollaborative();
    });

    // --- KHỞI TẠO VÀ VẼ LẦN ĐẦU ---
    function initialize() {
        // Điều chỉnh kích thước canvas cho phù hợp với container
        const resizeCanvas = (canvas) => {
            const container = canvas.parentElement;
            const style = getComputedStyle(container);
            const width = parseInt(style.width, 10);
            const height = parseInt(style.height, 10);
            canvas.width = width;
            canvas.height = height > 200 ? height : (width * 0.75); // Tỷ lệ 4:3
        };
        
        resizeCanvas(canvasContent);
        resizeCanvas(canvasCollab);

        drawContentBased();
        drawCollaborative();
    }
    
    // Vẽ lại khi thay đổi kích thước cửa sổ
    window.addEventListener('resize', initialize);

    // Chạy lần đầu
    initialize();
});
</script>
</body>
</html>

